<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Article">
  <head>
    
    <meta charset='utf-8'>
    <title>
        
            Monax Industries
        
    </title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="http://localhost/images/favicon.ico">

    

  




  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://localhost" />
  <meta property="og:title" content="Monax Industries" />


  <meta property="og:description" content="Core Solidity developer explains what not to do when creating a DAO" />


  <meta property="og:image" content="http://localhost/images//2016-06-18-doug-dao.png%!(EXTRA string=2016)" />
  <meta property="og:image" content="/images/ei-logo-sharing-square.png" />




    <meta name="twitter:card" content="summary_large_image" />

<meta name="twitter:site" content="@eris_ltd" />
<meta name="twitter:title" content="Monax Industries" />

  <meta name="twitter:title" content="Monax Industries" />


  <meta name="twitter:description" content="Core Solidity developer explains what not to do when creating a DAO" />


  <meta name="twitter:image" content="http://localhost/images//2016-06-18-doug-dao.png%!(EXTRA string=2016)" />
  <meta name="twitter:image" content="/images/ei-logo-sharing-square.png" />


  <meta name="twitter:creator" content="@eris_ltd">



<meta name="keywords" content="blockchain,smart,contracts,data,driven,relationship,bft" />

  <meta itemprop="name" content="Monax Industries" />


  <meta name="description" content="Core Solidity developer explains what not to do when creating a DAO" />


  <meta itemprop="image" content="http://localhost/images//2016-06-18-doug-dao.png%!(EXTRA string=2016)" />
  <meta itemprop="image" content="/images/ei-logo-sharing-square.png" />



    
    <link rel="stylesheet" type="text/css" href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' />
    
        <link rel="stylesheet" type="text/css" href='http://localhost/styles/eris.css' />
    

    
    
  </head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container-fluid col-xs-12 col-sm-12 col-med-8 col-med-offset-2 col-lg-8 col-lg-offset-2">
    <div class="navbar-header">
      <a class="navbar-brand page-scroll" href="https://monax.industries">{% image ei-logo-long-mobile.png alt="Eris Industries" %}</a>
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Components <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="https://monax.industries/components/eriscli">eris:cli</a></li>
            <li><a href="https://monax.industries/components/erisdb">eris:db</a></li>
            <li><a href="https://monax.industries/components/epm">eris:pm</a></li>
            <li><a href="https://monax.industries/components/erislegal">eris:legal</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="https://monax.industries/products/">Products <span class="caret"></span></a>
        </li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Documentation <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="https://docs.erisindustries.com">Overview</a></li>
            <li><a href="https://docs.erisindustries.com/tutorials/getting-started/">Get Started</a></li>
            <li><a href="https://docs.erisindustries.com/explainers">Explainers</a></li>
            <li><a href="https://docs.erisindustries.com/tutorials">Tutorials</a></li>
            <li><a href="https://docs.erisindustries.com/documentation">Technical Details</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="https://monax.industries/products/">Products <span class="caret"></span></a>
        </li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">About <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="https://monax.industries/about/team">Team</a></li>
            <li><a href="https://monax.industries/about/jobs">Positions</a></li>
            <li><a href="https://monax.industries/about/media">Media</a></li>
          </ul>
        </li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Connect <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="https://support.erisindustries.com" target="_blank"><i class="fa fa-ambulance"></i> Support Forums</a></li>
            <li><a href="https://slack.eris.industries"><i class="fa fa-weixin"></i> Chat Support (Slack)</a></li>
            <li><a href="mailto:contact@erisindustries.com"><i class="fa fa-envelope"></i> Business Contact Email</a></li>
            <li class="divider"></li>
            <li><a href="https://github.com/eris-ltd" target="_blank"><i class="fa fa-github-square"></i> Github</a></li>
            <li class="divider"></li>
            <li><a href="https://twitter.com/eris_ltd" target="_blank"><i class="fa fa-twitter-square"></i> Twitter</a></li>
            <li><a href="https://www.facebook.com/erisindustries" target="_blank"><i class="fa fa-facebook-square"></i> Facebook</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


<div class="container-fluid" id="eris-page">
  
    <div class="row">
      <div class="col-xs-12 col-sm-12 col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2 page-header">
        <header><h1 class="title" role="title">Lessons on Preparation for Disaster from the DAO</h1></header>
      </div>
    </div>
  

  <div class="row">
    <article id="main-content">
      <div class="col-xs-12 col-sm-12 col-md-10 col-md-offset-2 col-lg-6 col-lg-offset-4" id="content-block">
        

<p>Much has been written about the fall of the DAO in the past 24 hours and there has been a lot of talk of what happened and what didn&rsquo;t happen that should have happened. I&rsquo;m not going to talk about how it happened. There are many colorful and wonderful pieces explaining the attack, one of which I recommend reading for this particular instance is <a href="http://vessenes.com/deconstructing-thedao-attack-a-brief-code-tour/" target="_blank">Peter Vessenes&rsquo;s</a>
(And seriously subscribe to that blog if you&rsquo;re developing smart contracts because that dude comes up with amazing and critical stuff that every solidity programmer should be made aware of).</p>

<p>I am instead writing today to talk about how the DAO should have been written instead to prevent not only this security flaw, but any other security flaws inherent in it. As one of the core developers of the Solidity programming language itself, I also will be discussing some ideas from the team and the Ethereum community to prevent problems like the Reentry attack from occurring on a scale like this again.</p>

<h2 id="back-to-basics">Back to Basics</h2>

<p>Be very careful with how you write your code, and always test it first, and thoroughly. Unlike normal code, once this bugs up, it&rsquo;s there permanently, unless you put in the ability to destroy the contract. The problem that caused this whole spat was one line of code. That&rsquo;s right. ONE. LINE. OF. CODE.</p>

<p>Here is the code that destroyed the DAO.</p>
function payOut(address _recipient, uint _amount) returns (bool) {
        if (msg.sender != owner || msg.value > 0 || (payOwnerOnly && _recipient != owner))
            throw;
        if (_recipient.call.value(_amount)()) {
            PayOut(_recipient, _amount);
            return true;
        } else {
            return false;
        }
    }

<p>and</p>
if (!rewardAccount.payOut(_account, reward))
    throw;
paidOut[_account] += reward;
return true;

<p>note where the reward is added enabling someone to recursively drain the DAO with multiple calls. This is accidentally mitigated by using msg.sender.send(), but the slock.it team decided to use call here&hellip;a much lower level function that does not put a gas stipend down, enabling a user to call with as much gas as they need from a contract to recursively call the paidOut function. But really, all of this is solved if the line containing:</p>

<p><code>paidOut[_account] += reward;</code></p>

<p>is simply moved above the payOut function. Crazy I know. Key takeaways from this:</p>

<blockquote>
<blockquote>
<p><strong>1. Make sure you&rsquo;re careful where you place your sends.</strong>
<strong>2. Don&rsquo;t trust and interact with unknown contracts. If you can&rsquo;t predict what it will do it&rsquo;s very hard to design for it.</strong></p>
</blockquote>
</blockquote>

<p>But what about security faults we don&rsquo;t know about yet? What do we do about those. The answer to this question is two fold. It revolves around modular design and smart decentralized decision making.</p>

<h2 id="modular-contract-development">Modular Contract Development</h2>

<p>The Ethereum community has recently been evoking a trusted hero of my time when it comes to this tragedy: Captain Hindsight.</p>

<p>{{ page.date | date: &ldquo;%Y&rdquo; | append:&lsquo;/2016-06-18-captainHindSight.jpg&rsquo; | img }}</p>

<p>With his trusty companions Shoulda, Coulda and Woulda, he swiftly points out that the DAO is far too complex and should have been made with easier and simpler code as well as in a more modular fashion. This would have made the code easier to update as well as audit. Drawing from lessons in the Five Types Model, let&rsquo;s explore the usage of a DOUG or a Decentralized Organization Upgrade Guy.</p>

<p>Using a DOUG, we would be able to dynamically include more and even reduce the number of contracts, so long as we kept it around a handful of core modules. This would make the code very updateable and easily so. Here&rsquo;s a small example of how it might be designed.</p>
contract DOUG_Of_Da_DAO {
    // our core modules live here, mapped to a string for ease of update
    mapping(string => address) coreModules;
    // this is all the dependencies required of our core module.
    // Note that you could combine this with the above to create a triple mapping,
    // but for ease of documentation I am separating it.
    mapping(address => mapping(string => address)) moduleDependencies;

    function updateCoreModule(string moduleName, address moduleAddress) {
        coreModules[moduleName] = moduleAddress;
    }

    function updateDependencyModule(string coreModuleName, string dependencyModuleName, address dependencyModuleAddress) {
        moduleDependencies[coreModules[coreModuleName]][dependencyModuleName] = dependencyModuleAddress;
    }

}

<p>You may be asking &ldquo;What&rsquo;s to stop someone from maliciously updating the DAO then to whatever they want it to be&rdquo;. I have purposely left that out of here so that I can tie this into my next bit&hellip;starting now.</p>

<h2 id="executive-action">Executive Action</h2>

<p>One of the reasons why the United States and many other democratic institutions have an executive branch is for the reason that democracy overall moves far too slowly to respond in moments of crisis.
Seeing this is also why it becomes so tragic for the DAO, because the DAO team had been made aware of the bug and had actually gone in and FIXED their code.
However because there was no executive to decidedly update their code immediately (would have required a vote, which takes quite a sum of time to gather), the attacker was able to jump on the opportunity.</p>

<p><code>(Side Note: if you ever see a bug that critical, don't leave it out in the public eye as a white hat, please report it privately if you can. Resort to public disclosure as a last resort if the developer is being an arrogant tool).</code></p>

<p>All forms of security etiquette aside, had the DAO given a group of democratically elected devs executive ability selected in round robin fashion to update the addresses of certain portions of the code in situations like these, this likely would have never happened and been fixed immediately. Let&rsquo;s go back to our DOUG:</p>
contract DOUG_Of_Da_DAO {
    // our core modules live here, mapped to a string for ease of update
    mapping(string => address) coreModules;
    // this is all the dependencies required of our core module.
    // Note that you could combine this with the above to create a triple mapping,
    // but for ease of documentation I am separating it.
    mapping(address => mapping(string => address)) moduleDependencies;

    function updateCoreModule(string moduleName, address moduleAddress) {
        coreModules[moduleName] = moduleAddress;
    }

    function updateDependencyModule(string coreModuleName, string dependencyModuleName, address dependencyModuleAddress) {
        moduleDependencies[coreModules[coreModuleName]][dependencyModuleName] = dependencyModuleAddress;
    }

}

<p>Suppose we wanted to implement a decentralized security executive. We need to have it created from a vote weighed by the DAOs stakeholders, and we also need to make sure that the security executive cannot maliciously take over the DAO and keep them in power. While we won&rsquo;t go into all of the necessary things (stake deposits that suicide should they make a decision the community dislikes).</p>

<p>The following is an example of what we would want then in a very centralized fashion. Keep in mind you could get creative with this and make it so that the decision to update is controlled by an odd number of people so that there will always be a resounding yes or no agreement, complete with incentives to make sure that the security people vote. That said it&rsquo;s a little complex for our purposes, so we&rsquo;ll stick with the current way to show a framework for how to do this.</p>

contract balanceSheet {
    mapping(address => uint) public balances;
    function getBalance() returns (uint balance) {
        balance = balances[msg.sender];
    }
}

contract securityVote { //holds long term information that will likely not need to change immediately
    //list of modules that security executives are not allowed to update
    address[] blacklist;
    //the current head honcho
    address public currentSecurityExecutive;
    balanceSheet users;
    struct voteNextExec { //could be done with some form of iterable mapping, but this was easier for our purposes
        mapping(address => bool) initialized;
        mapping(address => uint) index;
        mapping(address => bool) voted;
        uint totalCandidates;
        address[] execs;
        uint[] voteWeight;
    }
    voteNextExec vote;
    //time limit to vote in an exec
    uint constant timeLimit = 1 weeks;
    //two key modules that security execs should not be able to update,
    //this current module, and the balance sheet of all user tokens.
    //we will trust the creator in the interim to be a decent security executive but then leave it to the voters.
    function securityVote(address balanceSheetAddr) {
        blacklist.push(balanceSheetAddr);
        blacklist.push(address(this));
        currentSecurityExecutive = msg.sender;
        users = balanceSheet(balanceSheetAddr);
    }

    function voteForSecurityExec(address desired) {
        if (vote.voted[msg.sender]) //if already voted, kick them out
            throw;
        if (vote.initialized[desired]) { //add more to balance
            vote.voted[msg.sender] = true;
            vote.voteWeight[vote.index[desired]] += users.getBalance();
        }
        else { //initialize new candidate
            vote.voted[msg.sender] = true;
            vote.index[desired] = vote.totalCandidates++;
            vote.execs[vote.totalCandidates] = desired;
            vote.voteWeight[vote.index[desired]] = users.getBalance();
        }
    }
}

contract DOUG_Of_Da_DAO {

    address currentSecurityExecutive;
    securityVote currentSecurityConsensus;

    function DOUG_Of_Da_DAO(address securityAddr) {
        currentSecurityConsensus = securityVote(securityAddr);
    }

    modifier currentSecurityGuy() { //only our security guy can update contracts
        if (currentSecurityConsensus.currentSecurityExecutive() != msg.sender)
            throw;
        _
    }
    // our core modules live here, mapped to a string for ease of update
    mapping(string => address) coreModules;
    // this is all the dependencies required of our core module.
    // Note that you could combine this with the above to create a triple mapping,
    // but for ease of documentation I am separating it.
    mapping(address => mapping(string => address)) moduleDependencies;

    function updateCoreModule(string moduleName, address moduleAddress) currentSecurityGuy() {
        coreModules[moduleName] = moduleAddress;
    }

    function updateDependencyModule(string coreModuleName, string dependencyModuleName, address dependencyModuleAddress) currentSecurityGuy() {
        moduleDependencies[coreModules[coreModuleName]][dependencyModuleName] = dependencyModuleAddress;
    }

}

<h2 id="what-solidity-is-doing-about-this">What Solidity Is Doing About This</h2>

<p>Currently we are talking about ways to minimize reentrancy attack. There is an issue up in the Solidity github that discusses a suggestion from <a href="https://github.com/ethereum/solidity/issues/662" target="_blank">Micah Zoltu</a> to add a default boolean in all external calls that prevents recursive calls. For people who know what they&rsquo;re doing and want recursive calls, the default mechanism could be overridden by people who know what they are doing with a universal modifier named &ldquo;reentrant&rdquo;.</p>

<p>Beyond that, Christian and I are working tirelessly to bring you new features for Solidity as well as better documentation of best practices whenever you are coding smart contracts. We hope that this will be the beginning of NASA like documentation of attacks and what and what not to do whenever coding in Solidity.</p>

      </div>
    </article>
  </div>
</div>

</div>
</div>
<footer>
  <p>Copyright &copy; 2014-2016 Eris Industries</p>
</footer>
</body>


<div id="toc" class="well col-md-4 col-sm-6">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#back-to-basics">Back to Basics</a></li>
<li><a href="#modular-contract-development">Modular Contract Development</a></li>
<li><a href="#executive-action">Executive Action</a></li>
<li><a href="#what-solidity-is-doing-about-this">What Solidity Is Doing About This</a></li>
</ul></li>
</ul>
</nav>
</div>
<script type="text/javascript">
  var clicky_site_ids = clicky_site_ids || [];
  clicky_site_ids.push( 100753928 );
  (function() {
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//static.clicky.com/js';
    ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
  })();
</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.clicky.com/100753928ns.gif" /></p></noscript>
</html>